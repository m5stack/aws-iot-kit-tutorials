<!-- HTML header for doxygen 1.9.3-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Core2 for AWS IoT Kit BSP: Audio</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8V9B1GPE56"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-8V9B1GPE56');
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="AWS_logo_RGB.png"/></td>
  <td id="projectalign">
   <div id="projectname">Core2 for AWS IoT Kit BSP<span id="projectnumber">&#160;2.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Audio </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The audio library provides convenience functions for the SPM1423 microphone and the speaker powered by the NS4168 1-Watt amplifier over I2S. The I2S bus requires that the initialization and use of the peripheral on the bus is assigned to a dedicated processor core. The reason for this is that I2S and I2C attaches an interrupt to one of 32 interrupt vectors available per core. Attempting to initialize or access the peripheral without affinity to a specific core will most likely cause a hard fault almost immediately or at some point in time. The speaker or microphone must be enabled prior to performing the respective write or read operation.</p>
<p ><a class="anchor" id="audio_lib"></a></p>
<p >The default audio recording and playback configuration for both the microphone and speaker is mono (right only) channel, 16-bit, at 44,100Hz.</p>
<dl class="section note"><dt>Note</dt><dd>The microphone cannot be accessed at the same time as the speaker since they share a common clock pin (GPIO0). The library is currently not thread-safe and the application must exercise caution when reading/writing to the peripherals.</dd></dl>
<p><a href="./block_diagram-spm1423.png"><img src="./block_diagram-spm1423.png" alt="Circuit Block Diagram for the SPM1423 microphone" class="center" class="inline"/></a></p>
<p ><a href="./block_diagram-ns4168.png"><img src="./block_diagram-ns4168.png" alt="Circuit Block Diagram for the speaker powered by the NS4168 1w amplifier" class="center" class="inline"/></a></p>
<p >To enable the BSP hardware features, open the KConfig menu using the command <code>pio run --environment core2foraws --target menuconfig</code> from within the root of the project directory in your <a href="/en/blinky-hello-world/prerequisites.html#open-the-platformio-cli-terminal-window">PlatformIO terminal window</a> and go to the menu <code>Component Config --&gt; Core2 for AWS hardware features</code> to set the features you want to enable.</p>
<h1><a class="anchor" id="mic_example"></a>
Example</h1>
<p >TThe following example creates a FreeRTOS task that's pinned to Core 1, which intializes the SPM1423 microphone, reads 307,200 bytes of audio to a dynamically allocated buffer in the external RAM, disables the microphone, enables the speaker, plays back the buffer from the speaker, disables the speaker, and then loops again after waiting 2 seconds.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;freertos/FreeRTOS.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;freertos/task.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;esp_log.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="core2foraws_8h.html">core2foraws.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *TAG = <span class="stringliteral">&quot;MAIN_AUDIO_DEMO&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> record_and_playback_task( <span class="keywordtype">void</span> *pvParams )</div>
<div class="line">{</div>
<div class="line">    ESP_LOGI( TAG, <span class="stringliteral">&quot;\tStarting microphone test&quot;</span> );</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> read_length = 307200;</div>
<div class="line">    int8_t *mic_buffer = ( int8_t * )heap_caps_malloc( read_length * <span class="keyword">sizeof</span>( int8_t ), MALLOC_CAP_SPIRAM );</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span>( <span class="keyword">true</span> )</div>
<div class="line">    {</div>
<div class="line">        memset( mic_buffer, 0, read_length );</div>
<div class="line"> </div>
<div class="line">        esp_err_t err = <a class="code hl_function" href="core2foraws__audio_8h.html#acccaaa852ccd350f120cc6d01efa1327">core2foraws_audio_mic_enable</a>( <span class="keyword">true</span> );</div>
<div class="line">        <span class="keywordflow">if</span> ( err == ESP_OK )</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">size_t</span> was_read_length;</div>
<div class="line">            esp_err_t err = <a class="code hl_function" href="core2foraws__audio_8h.html#a7a47ff2f74358e91dd6b0461229d7a96">core2foraws_audio_mic_read</a>( mic_buffer, read_length, &amp;was_read_length );</div>
<div class="line">            <span class="keywordflow">if</span> ( err == ESP_OK )</div>
<div class="line">                ESP_LOGI( TAG, <span class="stringliteral">&quot;Read %d bytes from mic!&quot;</span>, was_read_length );</div>
<div class="line">            <a class="code hl_function" href="core2foraws__audio_8h.html#acccaaa852ccd350f120cc6d01efa1327">core2foraws_audio_mic_enable</a>( <span class="keyword">false</span> );</div>
<div class="line"> </div>
<div class="line">            <a class="code hl_function" href="core2foraws__audio_8h.html#a2edb9db6b236f71ae2d003a27f6cadd3">core2foraws_audio_speaker_enable</a>( <span class="keyword">true</span> );</div>
<div class="line">            err = <a class="code hl_function" href="core2foraws__audio_8h.html#af3635e9879b2c6e5295e8ea123f15cf0">core2foraws_audio_speaker_write</a>( ( uint8_t * )mic_buffer, was_read_length );</div>
<div class="line">            <span class="keywordflow">if</span> ( err == ESP_OK )</div>
<div class="line">                ESP_LOGI( TAG, <span class="stringliteral">&quot;Wrote %d bytes to the speaker!&quot;</span>, was_read_length );</div>
<div class="line">            <a class="code hl_function" href="core2foraws__audio_8h.html#a2edb9db6b236f71ae2d003a27f6cadd3">core2foraws_audio_speaker_enable</a>( <span class="keyword">false</span> ); </div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        vTaskDelay( pdMS_TO_TICKS( 2000 ) );</div>
<div class="line">    }</div>
<div class="line">    free( mic_buffer );</div>
<div class="line"> </div>
<div class="line">    vTaskDelete( NULL );</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> app_main( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_function" href="core2foraws_8h.html#a8589c127068e67d5474515365b558051">core2foraws_init</a>();</div>
<div class="line"> </div>
<div class="line">    xTaskCreatePinnedToCore(    &amp;record_and_playback_task,      <span class="comment">// Pointer to the task entry function </span></div>
<div class="line">                                <span class="stringliteral">&quot;audioTest&quot;</span>,                    <span class="comment">// Friendly name of the task</span></div>
<div class="line">                                configMINIMAL_STACK_SIZE * 4,   <span class="comment">// Size of the task stack specified in bytes</span></div>
<div class="line">                                NULL,                           <span class="comment">// Pointer to parameters passed to task</span></div>
<div class="line">                                2,                              <span class="comment">// Priority the task will run (0 is lowest)</span></div>
<div class="line">                                ( TaskHandle_t * ) NULL,        <span class="comment">// Handle that the created task can be referenced</span></div>
<div class="line">                                1                               <span class="comment">// The CPU core to exexute the task</span></div>
<div class="line">                            );</div>
<div class="line">}</div>
<div class="ttc" id="acore2foraws_8h_html"><div class="ttname"><a href="core2foraws_8h.html">core2foraws.h</a></div><div class="ttdoc">Core2 for AWS IoT Kit general hardware driver APIs.</div></div>
<div class="ttc" id="acore2foraws_8h_html_a8589c127068e67d5474515365b558051"><div class="ttname"><a href="core2foraws_8h.html#a8589c127068e67d5474515365b558051">core2foraws_init</a></div><div class="ttdeci">esp_err_t core2foraws_init(void)</div><div class="ttdoc">Initializes enabled hardware features.</div></div>
<div class="ttc" id="acore2foraws__audio_8h_html_a2edb9db6b236f71ae2d003a27f6cadd3"><div class="ttname"><a href="core2foraws__audio_8h.html#a2edb9db6b236f71ae2d003a27f6cadd3">core2foraws_audio_speaker_enable</a></div><div class="ttdeci">esp_err_t core2foraws_audio_speaker_enable(bool state)</div><div class="ttdoc">Enables or disables the device speaker driver.</div></div>
<div class="ttc" id="acore2foraws__audio_8h_html_a7a47ff2f74358e91dd6b0461229d7a96"><div class="ttname"><a href="core2foraws__audio_8h.html#a7a47ff2f74358e91dd6b0461229d7a96">core2foraws_audio_mic_read</a></div><div class="ttdeci">esp_err_t core2foraws_audio_mic_read(int8_t *sound_buffer, size_t to_read_length, size_t *was_read_length)</div><div class="ttdoc">Writes audio to the provided buffer from the microphone.</div></div>
<div class="ttc" id="acore2foraws__audio_8h_html_acccaaa852ccd350f120cc6d01efa1327"><div class="ttname"><a href="core2foraws__audio_8h.html#acccaaa852ccd350f120cc6d01efa1327">core2foraws_audio_mic_enable</a></div><div class="ttdeci">esp_err_t core2foraws_audio_mic_enable(bool state)</div><div class="ttdoc">Enables or disables the device microphone driver.</div></div>
<div class="ttc" id="acore2foraws__audio_8h_html_af3635e9879b2c6e5295e8ea123f15cf0"><div class="ttname"><a href="core2foraws__audio_8h.html#af3635e9879b2c6e5295e8ea123f15cf0">core2foraws_audio_speaker_write</a></div><div class="ttdeci">esp_err_t core2foraws_audio_speaker_write(const uint8_t *sound_buffer, size_t to_write_length)</div><div class="ttdoc">Writes the provided buffer for speaker playback.</div></div>
</div><!-- fragment --><h1><a class="anchor" id="audio_preprocessor_macros"></a>
Preprocessor Macros</h1>
<ul>
<li><a class="el" href="audio_i2s_number_macro.html">AUDIO_I2S_PORT_NUM</a> <br  />
</li>
<li><a class="el" href="audio_sampling_freq_macro.html">AUDIO_SAMPLING_FREQ</a> <br  />
</li>
</ul>
<h1><a class="anchor" id="audio_functions"></a>
Functions</h1>
<ul>
<li><a class="el" href="core2foraws_audio_speaker_enable_function.html">core2foraws_audio_speaker_enable</a> <br  />
</li>
<li><a class="el" href="core2foraws_audio_speaker_write_function.html">core2foraws_audio_speaker_write</a> <br  />
</li>
<li><a class="el" href="core2foraws_audio_mic_enable_function.html">core2foraws_audio_mic_enable</a> <br  />
</li>
<li><a class="el" href="core2foraws_audio_mic_read_function.html">core2foraws_audio_mic_read</a> <br  />
 </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
